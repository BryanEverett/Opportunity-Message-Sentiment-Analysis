
###INBOUND ACTIVITIES LAST 20 DAYS###


-- CTE to get timestamp of most recent activity for each opp
with
  la as (
    select -- get opp name and date of most recent activity
      o.name as opp
      , max(t.created_date) as LastActivity
    from -- need task, account, user, and opporunity fields from Salesforce; user and account could probably be removed, but this was pasted from query below to get most recent activity
      salesforce_fivetran.task t
      join salesforce_fivetran.account a on
        t.account_id = a.id
      join salesforce_fivetran.user u on
        t.created_by_id = u.id
      join salesforce_fivetran.opportunity o on
        o.account_id = a.id
    where
    -- [Activity_age[1]] is a Sisense dashboard filter insert
      t.created_date > (current_date - [Activity_Age|1]) -- allow manager to select time range he wants to look at (20 was selected for screenshot)
      and u.title = 'Account Executive'
      and o.stage_name in ( -- focusing on later stage deals
        'Negotiation'
        , 'Proposal'
        , 'POC'
      )
      and subject like '%[In]%' -- every inbound email logged in Outreach is tagged with "[In]" in the subject line
    group by
      o.name -- Want just the most recent message for each opp
  )

-- Final query to bring in last activity timestamp, count of activities on opp within period selected, opp details like stage and close date, and finally a link to the opp that my manager can click to take him to the Salesforce record
select
  (
    u.first_name || ' ' || u.last_name
  )
  as Rep_Name
  , o.name Opp_Name
  , o.stage_name
  , o.close_date
  , la.LastActivity as Last_Activity -- last activity from CTE above
  , count(o.name) as "Activities Previous [Activity_Age] Days" -- count of activities within selected timerange on each opp; name of column dynamic based on filter selection
  , ('https://periscopedata.my.salesforce.com/' || o.id) as Link_to_Opp -- clickable link to opp generated by URL + opportunity record id
from
  salesforce_fivetran.task t -- table storing information on email, call, and other activities logged in salesforce
  join salesforce_fivetran.account a on -- table storing information on accounts in Salesforce
    t.account_id = a.id
  join salesforce_fivetran.user u on -- table storing information on users in Salesforce
    t.created_by_id = u.id
  join salesforce_fivetran.opportunity o on -- table storing information on opportunities in Salesforce
    o.account_id = a.id
  join la on
    o.name = la.opp
where
  t.created_date > (current_date - [Activity_Age|1]) -- look up tasks within day range selected on dashboard level
  and u.title = 'Account Executive'
  and (
    o.stage_name in ( -- include all opps in Negotiation or proposal stage
      'Negotiation'
      , 'Proposal'
    )
    or (
      o.stage_name in ( -- include only opps in POC stage that have a close date within 60 days of current day
        'POC'
      )
      and o.close_date <= (current_date + 60)
    )
  )
  and [o.close_date=close_date] -- allow management to further filter to a specific close date via dashboard vilters
  and subject like '%[In]%' -- filtering to only inbound messages
group by -- ultimately grouped by opportunity name to get total opportunities and last activity for each opp
  o.name
  , u.first_name
  , u.last_name
  , a.name
  , o.stage_name
  , o.id
  , o.close_date
  , o.last_activity_date
  , la.LastActivity
order by -- intend to keep tabs on activity on opps as they are coming up on close dates
  o.close_date
